<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Tic Tac War</title>
  <link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/3.8.1/build/cssreset/cssreset-min.css">
  <link rel="stylesheet" type="text/css" href="/style.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
</head>
<body>

  <select id="roomSelector">
    <option value="room-1">Room 1</option>
    <option value="room-2">Room 2</option>
  </select>

  <select id="heroSelector">
    <option value="warrior">Warrior</option>
    <option value="mage">Mage</option>
    <option value="hunter">Hunter</option>
    <option value="rogue">Rogue</option>
    <option value="warlock">Warlock</option>
    <option value="priest">Priest</option>
    <option value="pirate">Pirate</option>
    <option value="paladin">Paladin</option>
    <option value="ninja">Ninja</option>
  </select>

  <!-- <select id="sideSelector">
    <option value="0">◯</option>
    <option value="1" selected>×</option>
  </select> -->

  <button id="enter">Enter</button>

  <div class="progress">
    <div class="progress-bar"></div>
  </div>

  <div id="wrapper">
    <i class="fa fa-flag fa-2x icon1"></i>
    <table id="panel"></table>
    <i class="fa fa-flag fa-2x icon2"></i>
  </div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="/class.js"></script>
  <script>
  $(function(){
    'use strict';
    var socket = io.connect();
    var board = new Board(9);
    var initialized = false;

    var player = new Player(0);
    var game = new Game(player, board);
    // Game Initialization
    game.initialize();

    $('#enter').click(function() {
      socket.emit('emit_room', $('#roomSelector').val());
    });

    socket.on('emit_id', function(data) {

        if (!initialized) {

          player = new Player(data);
          game.player = player;
          initialized = true;

        }
      });


      //Game Procedures

      $('td').click(function() {

        if (player.myTurn){

          if ($(this).hasClass('chosen')){

            alert('Invalid move!');

          } else {
            //My Move
            var row1 = parseInt($(this).parent().attr('id').charAt(3)),
                column1 = parseInt($(this).attr('id').charAt(6));
            var myMove = new Move(row1, column1, player, false);
            board.update(myMove);
            board.display(myMove);

            socket.json.emit('emit_from_client', {
              room: $('#roomSelector').val(),
              enemyMove: myMove
            });

            game.timeCount = 0;
            clearTimeout(game.timerId);
            $('.progress-bar').css('width', '100%');
            if (!board.gameOn(myMove)) {
                alert('You win!');
                location.href = "";
            }

            player.myTurn = false;

            setTimeout(function() {

              var srow, scolumn, grow, gcolumn;

              while (true) {

                srow = Math.floor(Math.random(1) * board.subSize);
                scolumn = Math.floor(Math.random(1) * board.subSize);
                grow = Math.floor(Math.random(1) * board.subSize);
                gcolumn = Math.floor(Math.random(1) * board.subSize);
                var check = board.subGrid[grow][gcolumn].grid[srow][scolumn];
                if (!(check === 1 || check === 0)) {
                  break;
                }
              }

              var row = grow * 3 + srow,
                  column = gcolumn * 3 + scolumn;
              var rmove = new Move(row, column, player, true);
              board.update(rmove);
              board.display(rmove);

              socket.json.emit('emit_from_client', {
                room: $('#roomSelector').val(),
                enemyMove: rmove
              });

              if (!board.gameOn(myMove)) {
                alert('You win!');
                location.href = "";
              }

            }, 500);


          }

        } else {

          alert('It\'s not your turn!');

        }


      });

      socket.on('emit_from_enemy', function(data) {
        board.update(data.enemyMove);
        board.display(data.enemyMove);
        if (!board.gameOn(data.enemyMove)) {
          alert('You lose!');
          location.href = "";
        }

        if (data.enemyMove.random) player.myTurn = true;

      });


    });
  </script>
</body>
</html>