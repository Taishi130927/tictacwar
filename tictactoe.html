<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Tic Tac War</title>
  <link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/3.8.1/build/cssreset/cssreset-min.css">
  <link rel="stylesheet" type="text/css" href="/style.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
</head>
<body>

  <select id="roomSelector">
    <option value="room-1">Room 1</option>
    <option value="room-2">Room 2</option>
  </select>

  <select id="heroSelector">
    <option value="warrior">Warrior</option>
    <option value="mage">Mage</option>
    <option value="hunter">Hunter</option>
    <option value="rogue">Rogue</option>
    <option value="warlock">Warlock</option>
    <option value="priest">Priest</option>
    <option value="pirate">Pirate</option>
    <option value="paladin">Paladin</option>
    <option value="ninja">Ninja</option>
  </select>

  <select id="sideSelector">
    <option>◯</option>
    <option selected>×</option>
  </select>

  <div class="progress">
    <div class="progress-bar"></div>
  </div>

  <div id="wrapper">
    <i class="fa fa-flag fa-5x icon1"></i>
    <table id="panel"></table>
    <i class="fa fa-flag fa-5x icon2"></i>
  </div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="/class.js"></script>
  <script>
  $(function(){
    'use strict';
    var socket = io.connect();

    // Board Initialization
    var game = true,
        timerId,
        timeCount = 0;

    var player = new Player("×", 'blue', false),
        board = new Board(7);

    function countOn(tc) {

      if (tc <= 300) {

        if (tc === 200) {
          $('.progress-bar').addClass('progress-bar-warning');
        } else if (tc === 270) {
          $('.progress-bar').addClass('progress-bar-danger');
        }

        timerId = setTimeout(function() {

                $('.progress-bar').css('width', 100 - tc * 100 / 300 + '%');
                countOn(tc + 1);

              }, 100);

      } else {

        clearTimeout(timerId);

      }
    }

    $('#roomSelector').change(function() {

      socket.emit('emit_room', $(this).val());
      if (player.side === "◯") {
        countOn(timeCount);
      }
    });

    $('#sideSelector').change(function() {

      player.side = $(this).val();
      player.sidecolor = (player.side === "◯")? 'red' : 'blue';
      player.myTurn = (player.side === "◯");

    });

    for (var i = 0; i < board.size; i++) {

      $('#panel').append('<tr id=row' + i +'></tr>');

        for (var j = 0; j < board.size; j++) {

          $('#row' + i).append('<td id=column' + j +'>  </td>');
        }
      }

      //Game Procedures

      $('td').click(function() {

        if (player.myTurn){

          if ($(this).hasClass('chosen')){

            alert('Invalid move!');

          } else {
            //My Move
            var row1 = parseInt($(this).parent().attr('id').charAt(3));
            var column1 = parseInt($(this).attr('id').charAt(6));
            var myMove = new Move(row1, column1, 0);
            board.update(myMove);
            board.display(player, myMove);

            socket.json.emit('emit_from_client', {
              room: $('#roomSelector').val(),
              enemyMove: myMove,
              enemy: player
            });

            timeCount = 0;
            clearTimeout(timerId);
            $('.progress-bar').css('width', '100%');
            if (!board.gameOn(myMove)) {
                alert('You win!');
                location.href = "";
              }

            player.myTurn = false;

          }

        } else {

          alert('It\'s not your turn!');

        }


      });

            socket.on('emit_from_enemy', function(data) {
              console.log(data);
              board.update(data.enemyMove);
             board.display(data.enemy, data.enemyMove);
              if (!board.gameOn(data.enemyMove)) {
                alert('You lose!');
                location.href = "";
              }
              player.myTurn = true;

            });


    });
  </script>
</body>
</html>