<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Tic Tac War</title>
  <link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/3.8.1/build/cssreset/cssreset-min.css">
  <link rel="stylesheet" type="text/css" href="/style.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
</head>
<body>

  <select id="roomSelector">
    <option value="room-1">Room 1</option>
    <option value="room-2">Room 2</option>
  </select>

  <select id="heroSelector">
    <option value="warrior">Warrior</option>
    <option value="mage">Mage</option>
    <option value="hunter">Hunter</option>
    <option value="rogue">Rogue</option>
    <option value="warlock">Warlock</option>
    <option value="priest">Priest</option>
    <option value="pirate">Pirate</option>
    <option value="paladin">Paladin</option>
    <option value="ninja">Ninja</option>
  </select>

  <button id="enter" class="test">Enter</button>

  <div id="indication1"></div>
  <div id="indication2"></div>

  <div class="progress">
    <div class="progress-bar"></div>
  </div>

  <div id="wrapper">
    <div id="heroArea2"><img id="icon2" alt=""></div>
    <div class="energy2">
      <div class="energy-bar2"></div>
    </div>
    <table id="panel"></table>
    <div class="energy1">
      <div class="energy-bar1"></div>
    </div>
    <div id="heroArea1"><img id="icon1" alt=""></div>
  </div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="/class.js"></script>
  <script>
  $(function(){
    'use strict';

    var board = new Board(9);
    var initialized = false;

    var playerHero, enemyHero;
    var id = -1;
    var player = new Player(0, 'warrior'),
        enemy = new Player(1, 'warrior');
    player.myTurn = false;
    var game = new Game(player, enemy, board);
    // Game Initialization
    game.initialize();

    $('#enter').click(function() {

        if (id === -1) {

        game.socket.json.emit('emit_room', {

          room: $('#roomSelector').val(),
          hero: $('#heroSelector').val()

        });

        playerHero = new Hero($('#heroSelector').val());
        $('#icon1').attr('src', playerHero.hurl);
        if (playerHero.hid === 0) $('#heroArea1').append('<div>charged: ' + playerHero.miscCount + '</div>');


      }
    });

    $('#icon1').click(function() {

      if (game.player.myTurn) {
      //console.log('test');
        if ((game.player.hero.hid !== 0 && game.player.energy === 100 )|| (game.player.hero.hid === 0 && game.player.hero.miscCount !== 0)) {

          game.socket.emit('emit_ability_from_client', $('#roomSelector').val());

          game.player.hero.powerOn = true;
          game.clearEnergy(true);
          $('#indication2').text('Use Your Ability!');

        }
      }
    });

    game.socket.on('emit_id', function(data) {
      id = data;
    });

    game.socket.on('emit_hero', function(data) {

        if (!initialized) {

          if (id === -1) id = data.id;

          enemyHero = new Hero(data.heroes[(id + 1) % 2]);
          $('#icon2').attr('src', enemyHero.hurl);

          player = new Player(id, playerHero);
          enemy = new Player((id + 1) % 2, enemyHero);

          game.player = player;
          game.enemy = enemy;
          $('.energy-bar1').css('top', 100 - game.player.energy + '%');
          $('.energy-bar1').css('height', game.player.energy + '%');
          $('.energy-bar2').css('top', 100 - game.enemy.energy + '%');
          $('.energy-bar2').css('height', game.enemy.energy + '%');
          initialized = true;
          $('#indication1').text('Your side is: ' + player.side);

          if (player.myTurn) {

            $('#indication2').text('Your turn!');
            game.countOn();

          } else {
            $('#indication2').text('Enemy turn!');
          }
        }
      });
      //Game Procedures

      $('td').click(function() {

        if (game.player.hero.powerOn) {

          if (game.player.hero.hid !== 3 && !$(this).hasClass('chosen')) {

            var row1 = parseInt($(this).parent().attr('class').charAt(3)),
                column1 = parseInt($(this).attr('class').charAt(6));
            var type = 0;

            if (game.player.hero.hid === 2) {
              type = 1;
            } else if (game.player.hero.hid === 4) {
              type = 2;
            }

            var myMove = new Move(row1, column1, game.player, false, type);
            game.applyHeroPower(myMove);

          } else if (game.player.hero.hid === 3 && $(this).hasClass('chosen')) {

            var row1 = parseInt($(this).parent().attr('class').charAt(3)),
                column1 = parseInt($(this).attr('class').charAt(6));
            var myMove = new Move(row1, column1, game.player, false, 0);

            if (game.board.subGrid[myMove.globalRow][myMove.globalColumn].grid[myMove.subRow][myMove.subColumn] === game.enemy.id) game.applyHeroPower(myMove);

          } else if (game.player.hero.hid === 4 && $(this).hasClass('chosen')) {

            var row1 = parseInt($(this).parent().attr('class').charAt(3)),
                column1 = parseInt($(this).attr('class').charAt(6));
            var myMove = new Move(row1, column1, game.player, false, 0);

            if (game.board.subGrid[myMove.globalRow][myMove.globalColumn].grid[myMove.subRow][myMove.subColumn] === 4 + game.player.id) game.applyHeroPower(myMove);

          }
        } else if (game.player.myTurn) {

          if ($(this).hasClass('chosen')) {

            // alert('Invalid move!');

          } else {
            //My Move
            var row1 = parseInt($(this).parent().attr('class').charAt(3)),
                column1 = parseInt($(this).attr('class').charAt(6));
            var myMove = new Move(row1, column1, game.player, false, 0);
            game.processMove(myMove);

            setTimeout(function() {

              var rmove = game.generateRandomMove();
              game.processMove(rmove);

            }, 500);

          }

        } else {

          // alert('It\'s not your turn!');

        }
      });

      game.socket.on('emit_from_enemy', function(data) {
        if (data.enemyMove !== null) {
          game.processMove(data.enemyMove);
        } else {
          game.switchTurn(false);
        }
      });

      game.socket.on('emit_ability_from_enemy', function(data) {
        //game.enemy.hero.powerOn = true;
        $('#heroArea2 div').remove();
        game.clearEnergy(false);

      });

      game.socket.on('emit_secret_from_enemy', function(data) {

        var move = data.enemyMove;
        game.board.subGrid[move.globalRow][move.globalColumn].grid[move.subRow][move.subColumn] = 2 + game.enemy.id;

      });
    });
  </script>
</body>
</html>